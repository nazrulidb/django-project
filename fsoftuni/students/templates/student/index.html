{% extends "student_base.html" %}
{% load static wagtailimages_tags %}

{% block body_class %}template-homepage{% endblock %}

{% block extra_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script>
<style>
    table{
        background:none;
    }
    .pdf-logo{
        width:75px;
        margin-right:10px;
        position: absolute;
        top: -20px;
        left: 65px;
    }
</style>
<script>
//window.addEventListener('load', (event) => {
    function demoFromHTML() {
        var pdf = new jsPDF('p', 'pt', 'letter');
        // source can be HTML-formatted string, or a reference
        // to an actual DOM element from which the text will be scraped.
        source = $('#pdfCon')[0];
    
        // we support special element handlers. Register them with jQuery-style 
        // ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
        // There is no support for any other type of selectors 
        // (class, of compound) at this time.
        specialElementHandlers = {
            // element with id of "bypass" - jQuery style selector
            '#bypassme': function (element, renderer) {
                // true = "handled elsewhere, bypass text extraction"
                return true
            }
        };
        margins = {
            top: 80,
            bottom: 60,
            left: 10,
            right: 10,
            width: 600
        };
        // all coords and widths are in jsPDF instance's declared units
        // 'inches' in this case
        pdf.addHTML(
        source, // HTML string or DOM elem ref.
        margins.left, // x coord
        margins.top, { // y coord
            'width': margins.width, // max width of content on PDF
            'elementHandlers': specialElementHandlers
        },
    
        function (dispose) {
            // dispose: object with X, Y of the last line add to the PDF 
            //          this allow the insertion of new lines after html
            pdf.save('Test.pdf');
        }, margins);
    }

    function testPDF(id){
        
        $('.pdf-hide').hide()
        let pdf = new jsPDF('p', 'pt', 'letter');
        id= '#pdfCon'+id;

        pdf.addHTML($(id)[0], function () {
            pdf.save('Test.pdf');
            $('.pdf-hide').show()
        
        });
    }

    
</script>
{% endblock extra_css %}

{% block institute_logo %}
    {% if page.logo %}
        {% image page.logo max-90x90 as image %}
        <img src="{{image.url}}" width="{{ image.width }}" height="{{ image.height }}" alt="{{ image.alt }}" class="navbar-logo">
    {% else %}
        
        <img src="{% static 'images/BUET_LOGO.svg.png' %}" class="navbar-logo" alt="logo">
    {% endif %}
{% endblock %}
{% block content_header %}
<div class="page-title">
    <h3>{{ page.welcome_title|safe }}</h3>

    {{ page.announcement|safe }}
</div>



{% endblock %}
{% block content %}

{% if request.user.get_publish_results %}
<div class="col col-4" style="margin-left:auto;">
    <select id="filterRes" class="form-control" style="max-width:300px;margin-left:auto;">
        <option selected value="all">All</option>
        {% for res in request.user.get_publish_results %}
            <option value="{{res.level}}-{{res.term}}">Level-{{res.level}} Term-{{res.term}}</option>
        {% endfor %}
    </select>
</div>
{% for res in request.user.get_publish_results %}

<div class="col-12 pdf-box" data-filter="{{res.level}}-{{res.term}}">
{% comment %} <button onclick="javascript:testPDF({{ res.id }});" style="margin-bottom:10px;" class="" href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-inbox"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg> Download PDF</button> {% endcomment %}

<a style="margin-bottom:10px;" class="" href="{% url 'exam_result' id=res.id %}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-inbox"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg> Download PDF</a>
</div>



<div id="pdfCon{{ res.id }}" data-filter="{{res.level}}-{{res.term}}" class="container pdf-box" style="max-width: 900px;;background-color:white;padding-left:1rem;padding-right:1rem;height:100%;margin-bottom:2rem;">  
    <div class="row">
        
        <div class="container" style="text-align:center;margin-bottom:0;margin-top:3rem;">
            <h3 style="position:relative;">
                <img src="{% static 'images/BUET_LOGO.svg.png' %}" class="pdf-logo" alt="logo">
                BANGLADESH UNIVERSITY OF TEXTILES
            </h3>
            <h5>
                GRADE SHEET (PROVISIONAL)
            </h5>
        </div>
        <div class="container" style="text-align:center;margin-bottom:1rem;margin-top:3rem;">
            <h5>
                B. Sc. in {{ request.user.department.name }} (Apparel)
            </h5>
            <h5>
                Level-{{res.level}} Term-{{res.term}}, Examination-{{res.year}} (Held in November-December,{{ res.exam_held }})
            </h5>
        </div>
        <div class="container">
            <h5>Student's Name      :   {{request.user}}</h5>
            <h5>Student's ID  No.   :   {{request.user.username}}</h5>
        </div>
        <table id="dTable" class="table table-hover non-hover" style="width:100%;">
            <thead>
                <tr>
                    <th style="width:9%;">Sl. No.</th>
                    <th style="width:16%;">Subject Code</th>
                    <th >Name of Subject</th>
                    <th  class="text-center">Credits</th>
                    <th style="width:16%;">Letter Grade</th>
                    <th style="width:16%;">Grade Points</th>
                </tr>
            </thead>
            <tbody>
                {% for item in res.get_subjects %}
                <tr>
                    <td>{{ item.no }}</td>
                    <td>{{ item.code }}</td>
                    <td>{{ item.subject }}</td>
                    <td>{{ item.credits }}</td>
                    <td>{{ item.letter_grade }}</td>
                    <td>{{ item.grade_point }}</td> 
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <table class="table table-hover non-hover" style="width:100%">
            <thead>
                <tr>
                    <th class="text-right" colspan=6>Total credits taken in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.total_credits_completed_in_this_term }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Total credits completed in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.total_credits_taken_in_this_term }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Grade Point Average (GPA) of the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.term_gpa }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Failed Subjects(s) in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.failed_subject }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Cummulative Grade Point Average (CGPA):</th>
                    <th colspan=4>{{ res.get_subject_headers.cgpa }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Results:</th>
                    <th colspan=4>{{ res.get_subject_headers.result }}</th>
                </tr>
            </thead>
        </table>
        <p style="padding-left:1rem;padding-right:1rem;">
            Minimum Countable Grade Point in Theory: 2.00 (Grade: D); Minimum Countable Grade Point in Practical: 2.25(Grade: C);<br>
            Requirement for Promotion (From Level to Level): CGPA 2.20 out of 4.00 and the cumulative total number of failed subjects<br>
            does not exceed the highest limit of 4(Four).
        </p>
        {% if not not_demo %}
        <div class="container">
            <img style="width:100%;object-fit:scale-down;" src="{% static 'images/grade-footer.png' %}" class="grade-footer img-responsive" alt="logo">
        </div>
        {% endif %}
        
    </div>
    {% if res.has_retake_result %}
    <div class="row">
        <div class="container" style="text-align:center;margin-bottom:0;margin-top:3rem;">
            <h3 style="position:relative;">
                <img src="{% static 'images/BUET_LOGO.svg.png' %}" class="pdf-logo" alt="logo">
                BANGLADESH UNIVERSITY OF TEXTILES
            </h3>
        </div>
        <div class="container" style="text-align:center;margin-bottom:1rem;margin-top:3rem;">
            <h5>
                Retake Result
            </h5>
        </div>
        <div class="container">
            <h5>Student's Name      :   {{request.user}}</h5>
            <h5>Student's ID  No.   :   {{request.user.username}}</h5>
        </div>
        <table id="dTable" class="table table-hover non-hover" style="width:100%;">
            <thead>
                <tr>
                    <th style="width:9%;">Sl. No.</th>
                    <th style="width:16%;">Subject Code</th>
                    <th >Name of Subject</th>
                    <th  class="text-center">Credits</th>
                    <th style="width:16%;">Letter Grade</th>
                    <th style="width:16%;">Grade Points</th>
                </tr>
            </thead>
            <tbody>
                {% for item in res.retake_subject %}
                <tr>
                    <td>{{ item.no }}</td>
                    <td>{{ item.code }}</td>
                    <td>{{ item.subject }}</td>
                    <td>{{ item.credits }}</td>
                    <td>{{ item.letter_grade }}</td>
                    <td>{{ item.grade_point }}</td> 
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <table class="table table-hover non-hover" style="width:100%">
            <thead>
                <tr>
                    <th class="text-right" colspan=6>Total credits taken in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.total_credits_completed_in_this_term }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Total credits completed in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.total_credits_taken_in_this_term }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Grade Point Average (GPA) of the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.term_gpa }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Failed Subjects(s) in the Term:</th>
                    <th colspan=4>{{ res.get_subject_headers.failed_subject }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Cummulative Grade Point Average (CGPA):</th>
                    <th colspan=4>{{ res.get_subject_headers.cgpa }}</th>
                </tr>
                <tr>
                    <th class="text-right" colspan=6>Results:</th>
                    <th colspan=4>{{ res.get_subject_headers.result }}</th>
                </tr>
            </thead>
        </table>
    </div>
    {% endif %}
</div>
{% endfor %}

{% else %}
<h1>No Data</h1>
{% endif %}

{% endblock content %}
{% block extra_js %}
<script>
    $("#filterRes").on('change', function(){
        console.log($(this).val())
        v = $(this).val();
        if(v === "all"){
            $(".pdf-box").show();
        }else{
            $(".pdf-box").hide();
            $("div[data-filter="+v+"]").show();
        }
    })
</script>
{% endblock %}